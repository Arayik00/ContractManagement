@page "/MyCompany"
@using ContractManagement.BL.Entities
@using ContractManagement.Model.Models

@inherits ContractManagement.UI.ProtectedPageBase
@inject HttpClient Http
@inject NavigationManager Nav
@inject ContractManagement.UI.Services.AuthService ClientJwtService


@rendermode InteractiveServer

@if (company == null)
{
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="height: 80px;">
                <th style="padding: 15px;">
                    <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 60px; border-radius: 8px;" />
                </th>
                <th style="padding: 15px;">
                    <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 60px; border-radius: 8px;" />
                </th>
                <th style="padding: 15px;">
                    <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 60px; border-radius: 8px;" />
                </th>
            </tr>
        </thead>

        <tbody>
            @for (int i = 0; i < 5; i++)
            {
                <tr style="height: 70px;">
                    <td style="padding: 15px;">
                        <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 50px; border-radius: 8px;" />
                    </td>
                    <td style="padding: 15px;">
                        <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 50px; border-radius: 8px;" />
                    </td>
                    <td style="padding: 15px;">
                        <MudSkeleton Variant="Variant.Rect" Animation="Animation.Wave" Width="100%" Height="100%" Style="min-height: 50px; border-radius: 8px;" />
                    </td>
                </tr>
            }
        </tbody>
    </table>




}
else if (company != null && company.CompanyName != "")
{
    <div>
        <h3>@company.CompanyName</h3>

        <div class="d-flex mb-3">
            <MudTextField @bind-Value="filter.searchKey"
                          Placeholder="Search..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" />
            <select @bind="filter.contractStatus" class="form-select w-auto">
                @foreach (var status in statuses)
                {
                    <option value="@status">@status</option>
                }
            </select>

            <select @bind="filter.pageSize" class="form-select w-auto">
                <option value=1>1</option>
                @for (int @i = 1; @i <= 4; @i++)
                {
                    <option value=@(i * 5)>@(i * 5)</option>
                }
            </select>

            <MudButton OnClick="getUpdatedList" Variant="Variant.Filled" Color="Color.Primary" Class="ms-2">Filter</MudButton>
        </div>
        <MudTable Items="@companyContracts" Style="cursor:default" Hover="true" Class="mud-table-bordered">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Position</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Start Date</MudTh>
                <MudTh>End Date</MudTh>
                <MudTh>Wage</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.User.FirstName @context.User.LastName</MudTd>
                <MudTd>@context.Position</MudTd>
                <MudTd>@context.Description</MudTd>
                <MudTd>@context.StartDate?.ToShortDateString()</MudTd>
                <MudTd>@context.EndDate?.ToShortDateString()</MudTd>
                <MudTd>@context.Wage.ToString("F2")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                   OnClick="@(() => EditContract(context.Id))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   OnClick="@(() => DeleteContract(context.Id))" />
                </MudTd>
            </RowTemplate>
        </MudTable>

        <MudButton OnClick="decrease" Disabled="@(!filterContractDto.hasPreviousPage)">Previous</MudButton>
        <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">

            @foreach (var j in Enumerable.Range(1, filterContractDto.totalPages))
            {
                <MudButton OnClick="@(() => { filter.pageNumber = j; UpdateList(); })"
                           Color="@(filter.pageNumber == j ? Color.Primary : Color.Default)">
                    @j
                </MudButton>
            }
        </MudButtonGroup>
        <MudButton OnClick="increase" Disabled="@(!filterContractDto.hasNextPage)">Next</MudButton>
    </div>
}
else
{
    <p>You don't seem to have a company yet.</p>
    <p>Click the <MudLink Href="/registerCompany" Color="Color.Primary" Underline="Underline.Always">link</MudLink> to create your first company.</p>
}

@code {
    // --- State ---
    private Companies company;
    private FilterContractDto filterContractDto = new();
    private List<ContractDto> companyContracts = new();
    private readonly string[] statuses = new[] { "All", "Active", "Finished", "NotStartedYet" };
    private bool firstRender = true;
    private int? adminId;
    private UserFilter filter = new UserFilter
    {
        searchKey = "",
        contractStatus = "All",
        pageNumber = 1,
        pageSize = 1
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        this.firstRender = false;

        var jwt = await ClientJwtService.GetTokenAsync();
        if (string.IsNullOrEmpty(jwt))
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        await UpdateList();
    }

    // --- Actions ---
    private async Task DeleteContract(int contractId)
    {
        var jwt = await ClientJwtService.GetTokenAsync();
        if (string.IsNullOrEmpty(jwt))
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        Http.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", jwt);

        var response = await Http.DeleteAsync($"/api/contracts/{contractId}");

        if (response.IsSuccessStatusCode)
        {
            await UpdateList();
        }
        else
        {
            Console.WriteLine("Failed to delete contract");
        }
    }

    private void EditContract(int id)
    {
        Nav.NavigateTo($"/editcontract/{id}");
    }

    private async Task UpdateList()
    {
        Console.WriteLine(filter.contractStatus);
        var id = await ClientJwtService.GetAdminIdFromJwtAsync();
        if (!id.HasValue)
            return;

        adminId = id;

        // Add Authorization header
        var jwt = await ClientJwtService.GetTokenAsync();
        Http.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", jwt);

        // Call API
        var companies = await Http.GetFromJsonAsync<List<Companies>>($"/api/companies/admin/{adminId}");
        if (companies.Count > 0)
        {
            Console.WriteLine(filter.contractStatus);

            company = companies.FirstOrDefault();
            var query = $"?contractStatus={filter.contractStatus}&pageNumber={filter.pageNumber}&pageSize={filter.pageSize}&searchKey={filter.searchKey}";
            Console.WriteLine(query);
            var url = $"/api/contracts/company/{company.Id}{query}";
            filterContractDto = await Http.GetFromJsonAsync<FilterContractDto>($"/api/contracts/company/{company.Id}{query}");

            var contracts = filterContractDto.contracts;
            if (contracts != null)
                companyContracts = contracts;
        }
        else
        {
            company = new();
            company.CompanyName = "";
        }
        StateHasChanged();

    }
    private async Task increase()
    {
        filter.pageNumber++;
        await UpdateList();
    }

    private async Task decrease()
    {
        filter.pageNumber--;
        await UpdateList();
    }

    private async Task getUpdatedList()
    {
        filter.pageNumber = 1;
        await UpdateList();
    }
}
